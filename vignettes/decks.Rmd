---
title: "Working with Crunch Decks"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Working with Crunch Decks}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

![Decks](https://support.crunch.io/crunch/crunch_saving-analyses.html) are the main way that Crunch helps you store and organize your analyses. You can save graphs, cross-tabs, and summaries to a deck and export it, set it as a dashboard, or share it with other analysts. When new data is added to the dataset, the results in the decks automatically update.

The **crunch** package provides an interface to programmatically create and manipulate decks in the Crunch app. You can create a deck from scratch in R using the `newDeck()` and `newSlide()` functions, and you can modify decks which have already been created in the web app. This vignette covers the latter use case.

We can view the decks associated with a dataset using the `decks` function

```{r, message=FALSE}
library(crunch)
```

```{r, results='hide', include = FALSE}
library(httptest)
start_vignette("decks")
```

```{r}
ds <- loadDataset("stackoverflow_survey_decks")
ds <- forkDataset(ds)
ds_decks <- decks(ds)
ds_decks
```
We have two decks associated with this dataset. To access a single deck, subset the deck catalog with either the name or the numeric index of the deck.

```{r}
gender_deck <- ds_decks[["Gender and Country"]]
name(gender_deck)
```

You can modify some attributes of decks, such as the name, the description, and whether the deck is available to all viewers of the dataset.

```{r, include=FALSE}
change_state()
```

```{r}
name(gender_deck) <- "Gender and Country (June 2017)"
name(gender_deck)
description(gender_deck) <- "Gender and Country, Stack Overflow Survey as of 2017"
is.public(gender_deck) <- TRUE
```

Decks contain slides. Each slide has a title and a subtitle, and you can get and set these with the `titles` and `subtitles` methods. In this case, we could change the slide title to specify the timeliness of the data, and split up the subtitles to make them easier for humans to read.
```{r, include=FALSE}
change_state()
```
```{r}
titles(gender_deck) <- paste(titles(gender_deck), "(2017 data)")
```
```{r, include=FALSE}
change_state()
```
```{r}
subtitles(gender_deck) <- gsub("([A-Z])", " \\1", subtitles(gender_deck))
titles(gender_deck)
subtitles(gender_deck)
```

We can access a slide by selecting from the deck with a numeric index.

```{r}
slide2 <- gender_deck[[2]]
slide2
```

You might notice that the printed slide looks a lot like a CrunchCube. Slides are essentially wrappers around cube queries with some additional settings and metadata. Indeed, you can assign the same formulas you use to create cubes into the `query` function to change what a slide displays. For example, we might want to flip the row and column variables:

```{r, echo=FALSE}
change_state()
```
```{r}
query(slide2) <- ~ TabsSpaces + Professional
slide2
```

Since the analyses in a slide contain cubes, you can access them with the `cube` function. This is useful if you want to do further analysis on the data.

```{r}
cube(slide2)
# You can also get a list of cubes for the whole deck
cube_list <- cubes(gender_deck)
cube_list[[2]]
```

# Copying Decks

You can copy decks by assigning them into the deck catalog for a dataset. This is useful if you have need to create several decks which are similar to one another. Currently it is only possible to copy decks within a dataset, not between datasets.

```{r, echo=FALSE}
change_state()
```
```{r}
ds_decks[["new deck"]] <- gender_deck
ds_decks
```
```{r, echo=FALSE}
with_consent(delete(ds))
end_vignette()
```
