---
title: "Working with Crunch Decks"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Working with Crunch Decks}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

![Crunch Decks](https://support.crunch.io/crunch/crunch_saving-analyses.html) are the main way that Crunch helps you organize your analyses. You can save graphs, cross-tabs, and summaries to a deck and export it, set it as a dashboard, or share it with other analysts. 

The **crunch** package provides an interface to programatically manipulate decks in the Crunch app. While it is possible to create a Deck from scratch in R using the `newDeck()` and `newSlide()` functions, for the most part you will probably be manipulating decks which have already been created in the web app. We can view the decks associated with a dataset using the `decks` function
```{r, message=FALSE}
library(crunch)
```

```{r, results='hide', include = FALSE}
library(httptest)
start_vignette("decks")
```

```{r}
library(crunch)
ds <- loadDataset("stackoverflow_survey_decks")
ds <- forkDataset(ds)
ds_decks <- decks(ds)
ds_decks
```
We have two decks associated with this dataset, to access a single deck, we can subset the DeckCatalog with either the numeric index of the deck we want, or the name of the deck. 

```{r}
gender_deck <- ds_decks[["Gender and Country"]]
name(gender_deck)
```

You can modify a couple of attributes of decks such as the name, the description, and whether the deck is public.

```{r, include=FALSE}
change_state()
```

```{r}
name(gender_deck) <- "Gender and Country (June 2017)"
name(gender_deck)
description(gender_deck) <- "Gender and Country, Stack Overflow Survey as of 2017"
is.public(gender_deck) <- TRUE
```

Decks are composed of slides. Each slide has a title and a subtitle, and you can get and set these with the `titles` and `subtitles` methods. In this case we could change the slide title to specify the timeliness of the data, and split up the subtitles to make them easier for humans to read. 
```{r, include=FALSE}
change_state()
```
```{r}
titles(gender_deck) <- paste(titles(gender_deck), "(2017 data)")
subtitles(gender_deck) <- gsub("([A-Z])", " \\1", subtitles(gender_deck))
titles(gender_deck)
subtitles(gender_deck)
```

We can access a slide by subsetting a deck using a numeric index. 

```{r}
slide2 <- gender_deck[[2]]
slide2
```

You might notice that the printed slide looks a lot like a CrunchCube, this is because the CrunchCube is the fundamental unit of analyses in Crunch, and slides are more or less wrappers around Cubes. Indeed you can assign the same formulas you use to create CrunchCubes into the `query` function to change what a slide displays. In this case we might want to flip the row and column variables. 

```{r, echo=FALSE}
change_state()
```
```{r}
query(slide2) <- ~TabsSpaces + Professional
slide2
```

Since the analyses in a slide are basically crunch cubes, you can access the cubes with the `cube` function. This is useful if you want to do further analysis on the data. 

```{r}
cube(slide2)
# You can also get a list of cubes for the whole deck
cube_list <- cubes(gender_deck)
cube_list[[2]]
```


# Modifying slide presentation
```{r}
#TODO wait for new API
```


# Copying Decks

You can copy decks by assigning them into the deck catalog for a dataset. Currently it is only possible to copy decks within a dataset and it is not possible to copy decks between datasets. This is useful if you have need to create several decks which are similar to one another. 
```{r, echo=FALSE}
change_state()
```
```{r}
ds_decks[["new deck"]] <- gender_deck
ds_decks
```
```{r}
with_consent(delete(ds))
end_vignette()
```