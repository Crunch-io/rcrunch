<!--
%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{Getting Started with RCrunch}
-->

# Crunch and RCrunch basics

Crunch is a cloud-based data store and analytic engine. It has a web client for doing the most common analytic tasks, allowing analysts and clients to see their data and interact with it. Most of the time, clients will use the web client to explore data, quickly making tables and graphs, filters and subsets. The *rcrunch* package for R allows analysts to interact with and manipulate Crunch datasets from within R.

```{r, message=FALSE}
library(rcrunch)
```

## The Crunch API

Both *rcrunch* and the Crunch web application talk to the same Crunch Application Programming Interface (API). Within an R script or interactive session, the rcrunch package is designed to make interacting with your data in Crunch into idiomatic R.

The Crunch API is served over secure http, and uses [Shoji](https://bitbucket.org/fumanchu/shoji/src), a way to structure APIs with JSON. When you call rcrunch functions, they'll take care of using [httr](https://github.com/hadley/httr) (which wraps [RCurl](http://www.omegahat.org/RCurl/)), and API responses are turned into R objects. Some functions act more like commands, such as `login()`, but its side effects are documented in the regular package documentation.

## Accounts

*Important: authentication to crunch.io with a username and password will change*

The first step after loading the rcrunch package is to log in:
```{r, eval=FALSE}
login(email="xkcd@crunch.io", password="correct horse battery staple")
```
```
## Logged into crunch.io as xkcd@crunch.io
```

```{r, results='hide', echo=FALSE, message=FALSE}
## Because the vignette tasks require communicating with a remote host,
## we do all the work ahead of time and save a workspace, which we load here.
## We'll then reference saved objects in that as if we had just retrieved them
## from the server
load("getting-started.RData")
```

This will log you in to the crunch API. All of these parameters can be also be set as R `options` so you can simply `login()`. See `?login` for details.

## Datasets and Variables

The Crunch data store is built around datasets, which contain variables. Unlike R data.frames and atomic vectors, Crunch datasets and variables have a lot of metadata. This vignette is going to use rcrunch to manipulate a dataset, alongside an instance of the same dataset in the web client. Many of the operations can be done with either client, but might be faster or easier to automate with R. 

# Adding datasets to Crunch

## Via the web client

In the web application, click *Import Data* and upload either a .csv or an SPSS .sav file. 

![Uploading data](upload.png)

## Adding datasets with rcrunch

Of course, you can also create datasets with rcrunch. There are two methods:

### 1. newDataset

You can create a dataset from any `data.frame` you have in your R session with `newDataset`:

```{r}
load("economist.RData")
dim(df)
```
```{r, eval=FALSE}
ds <- newDataset(df, name="Economist/YouGov Weekly Survey")
```
```{r}
dim(ds)
```

### 2. newDatasetFromFile

Alternatively, `newDatasetFromFile` essentially does what you would do in the web application: uploads your file and creates a dataset from it. If you have an SPSS or CSV file, you can upload it with that.

# Loading Crunch datasets into rcrunch

Datasets already existing on the Crunch server can be loaded with `loadDataset`. The function takes either the dataset's name, or the position within the dataset list returned by `listDatasets`:

```{r, eval=FALSE}
listDatasets()
```
```
## [1] "Economist/YouGov Weekly Survey"
```
```{r, eval=FALSE}
ds <- loadDataset("Economist/YouGov Weekly Survey")
```
```{r}
is.dataset(ds)
```

# Manipulating datasets

From here, we can set a number of dataset properties, such as toggling a weight variable, changing the name or adding a description, from within R, and our changes are carried out on the remote Crunch dataset.

## Hide Variables

Datasets often contain variables that you may want to use -- perhaps through a derived variable, a transformation, or a recode -- or that may simply not be relevant for the analytic tasks at hand. In short, you want to hide them. They aren't deleted, so you can restore them if you need them later, but they no longer clutter the dataset "workspace".

As with a typical R data.frame, you typically assign the return of a dataset-level function back to the variable representing the dataset in your R script or session. 

```{r, eval=FALSE}
ds <- hideVariables(ds, "comments")
hiddenVariables(ds)
```
```
## [1] "comments"
```

As with the `is.na` function, you can update a variable by assigning it to the hidden variables list.

```{r, eval=FALSE}
hiddenVariables(ds) <- "pid7others"
hiddenVariables(ds)
```
```
## [1] "comments"  "pid7others"
```

These variables are now hidden, both locally in your R session and remotely on the server, which you can see in the web application. And, just as you could restore them there, you can also restore them from R:

```{r unhide, eval=FALSE}
ds <- unhideVariables(ds, "pid7others")
hiddenVariables(ds)
```
```
## [1] "comments"
```
