context("Cube pairwise multiple comparisons")

##########################################
## fixutres from crunch cube
##########################################
hirotsu <- loadCube("cubes/pairwise-hirotsu-illness-x-occupation.json")
hirotsuTranspose <- loadCube("cubes/pairwise-hirotsu-occupation-x-illness.json")
sampled <- loadCube("cubes/cube-random-3x4.json")

test_that("Reference Chi-square from Z-tests.Rmd, 2017-10-26", {
    reference <- structure(c(NA, 1.79366044505363, 1.44505144460352, 1.52650609891684, 
                             1.79366044505363, NA, 3.96027410389113, 0.0252758760361623, 1.44505144460352, 
                             3.96027410389113, NA, 3.24682678277303, 1.52650609891684, 0.0252758760361623, 
                             3.24682678277303, NA), .Dim = c(4L, 4L),
                           .Dimnames = list(c("A", "B", "C", "D"), c("A", "B", "C", "D")))
    out <- pairwiseMatrix(sampled)
    expect_equal(out, reference)
})
test_that("Reference p values from Z-tests.Rmd, 2017-10-26", {
    reference <- structure(c(NA, 0.407860439751267, 0.48552440618817, 0.466147556812173, 
                             0.407860439751267, NA, 0.138050315949931, 0.987441585364219, 
                             0.48552440618817, 0.138050315949931, NA, 0.197224344940826, 0.466147556812173, 
                             0.987441585364219, 0.197224344940826, NA), .Dim = c(4L, 4L),
                           .Dimnames = list(c("A", "B", "C", "D"), c("A", "B", "C", "D")))
    out <- pairwiseMatrix(sampled, value="p.value")
    expect_equal(out, reference)
})

test_that("Pairwise comparison matrix for columns is equal to reference values", {
    # Note: These reference values generated from hirotsu data after building it using
    # the above sampled data. They differ from the Wishart versions found in Hirotsu,
    # but are included here if pairwise comparison is indeed wanted.
    reference <- structure(c(NA, 2.96093540688393, 0.932829050525787, 12.8371652127878, 
                             17.9893864373252, 0.928545742734045, 0.747992013063412, 9.63186987962947, 
                             1.43158631894219, 20.1171706792372, 2.96093540688393, NA, 1.76847831300577, 
                             8.98098998206645, 14.6017275773817, 0.435494345393219, 1.59902977683344, 
                             9.24994844117764, 0.260499250030443, 17.8112547073445, 0.932829050525787, 
                             1.76847831300577, NA, 22.2681630243698, 45.1233163291918, 0.188765827926188, 
                             1.19551172815931, 20.1305719083303, 0.945032186576934, 45.5038244877042, 
                             12.8371652127878, 8.98098998206645, 22.2681630243698, NA, 0.816415213502732, 
                             8.73362589158256, 5.36480999045035, 1.25267943759809, 3.83466528508909, 
                             2.26279769006118, 17.9893864373252, 14.6017275773817, 45.1233163291918, 
                             0.816415213502732, NA, 12.9245987246456, 7.58169347682279, 0.817077282842828, 
                             5.81838330801743, 0.781754999092818, 0.928545742734045, 0.435494345393219, 
                             0.188765827926188, 8.73362589158256, 12.9245987246456, NA, 0.660878111661309, 
                             7.75618456211458, 0.303388613890485, 15.6051920129687, 0.747992013063412, 
                             1.59902977683344, 1.19551172815931, 5.36480999045035, 7.58169347682279, 
                             0.660878111661309, NA, 3.8133007453977, 0.413328427993386, 9.63892077794325, 
                             9.63186987962947, 9.24994844117764, 20.1305719083303, 1.25267943759809, 
                             0.817077282842828, 7.75618456211458, 3.8133007453977, NA, 3.58397569023511, 
                             1.8412813174768, 1.43158631894219, 0.260499250030443, 0.945032186576934, 
                             3.83466528508909, 5.81838330801743, 0.303388613890485, 0.413328427993386, 
                             3.58397569023511, NA, 7.73836037271873, 20.1171706792372, 17.8112547073445, 
                             45.5038244877042, 2.26279769006118, 0.781754999092818, 15.6051920129687, 
                             9.63892077794325, 1.8412813174768, 7.73836037271873, NA),
                           .Dim = c(10L, 10L),
                           .Dimnames = list(c("1", "2", "3", "4", "5", "6", "7", "8","9", "10"), 
                                            c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10")))

    out <- pairwiseMatrix(hirotsu, dim="cols")
    expect_equal(out, reference)
})

test_that("Pairwise row is identical to direct transpose", {
    reference <- structure(c(NA, 87.9657697538273, 48.4241001009927, 
                             87.9657697538273, NA, 5.23229445690705,
                             48.4241001009927, 5.23229445690705, NA),
                           .Dim = c(3L, 3L), 
                           .Dimnames = list(c("slight", "medium", "serious"),
                                            c("slight", "medium", "serious")))
    rowMatrix <- pairwiseMatrix(hirotsuTranspose, dim="cols")
    colMatrix <- pairwiseMatrix(hirotsu, dim="rows")
    expect_equal(rowMatrix, colMatrix)
    expect_equal(rowMatrix, reference)
})

test_that("Wishart Chi-squared from Hirotsu, all-possible-comparisons.pdf, 2018-12-15", {
    reference <- structure(c(0, 2.82191015811665, 0.925971181878173, 12.7808554481281, 
                             16.797278696301, 0.924655442873681, 0.800897626931245, 9.61697239870243, 
                             1.44968631245103, 18.5560989371817, 2.82191015811665, 0, 1.68311327379593, 
                             8.68347185218156, 13.4510531592651, 0.38467827774871, 1.50949615300718, 
                             9.081312924348, 0.258339854060561, 16.3533306337074, 0.925971181878173, 
                             1.68311327379593, 0, 24.3489354234647, 46.6893860778998, 0.184708228257528, 
                             1.3765987079862, 22.0636585403878, 1.01021187951098, 47.6212400456597, 
                             12.7808554481281, 8.68347185218156, 24.3489354234647, 0, 0.807397908326374, 
                             8.49064125921564, 5.14174069410539, 1.25360048488748, 3.57624174509225, 
                             2.19745619878766, 16.797278696301, 13.4510531592651, 46.6893860778998, 
                             0.807397908326374, 0, 11.7920120113265, 6.84760936784522, 0.743555569450378, 
                             5.2183904567275, 0.725476017865348, 0.924655442873681, 0.38467827774871, 
                             0.184708228257528, 8.49064125921564, 11.7920120113265, 0, 0.707253783195803, 
                             7.620018353425, 0.332196968531903, 14.0875915538107, 0.800897626931245, 
                             1.50949615300718, 1.3765987079862, 5.14174069410539, 6.84760936784522, 
                             0.707253783195803, 0, 3.67243544094674, 0.396743262086735, 8.54615901952498, 
                             9.61697239870243, 9.081312924348, 22.0636585403878, 1.25360048488748, 
                             0.743555569450378, 7.620018353425, 3.67243544094674, 0, 3.4464292421171, 
                             1.59166956338692, 1.44968631245103, 0.258339854060561, 1.01021187951098, 
                             3.57624174509225, 5.2183904567275, 0.332196968531903, 0.396743262086735, 
                             3.4464292421171, 0, 6.85424450468994, 18.5560989371817, 16.3533306337074, 
                             47.6212400456597, 2.19745619878766, 0.725476017865348, 14.0875915538107, 
                             8.54615901952498, 1.59166956338692, 6.85424450468994, 0),
                           .Dim = c(10L, 10L),
                           .Dimnames = list(c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10"),
                                            c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10")))
    out <- wishartMatrix(hirotsu)
    expect_equal(out, reference)
})

test_that("Wishart rows equal to transposed cube", {
    reference <- structure(c(0, 88.0035314184012, 48.7265942784996, 88.0035314184012, 
                             0, 5.14221680596919, 48.7265942784996, 5.14221680596919, 0),
                           .Dim = c(3L, 3L),
                           .Dimnames = list(c("slight", "medium", "serious"),
                                            c("slight", "medium", "serious")))
    out <- wishartMatrix(hirotsu, dim="rows")
    expect_equal(out, reference)
    alt_out <- wishartMatrix(hirotsuTranspose)
    expect_equal(out, alt_out)
})